(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7567],{1619:(e,r,s)=>{"use strict";s.d(r,{AF:()=>p,Gu:()=>g,Nx:()=>m,Yf:()=>u,_z:()=>h}),s(14298);var t=s(53580),a=s(6807),i=s(53919),l=s(49509);let n=new Map,o=new Map,d=new Map,c=e=>!e.type||"connection"!==e.type,u=(e,r)=>{if(o.has(e))return;let s=l.env.NEXT_PUBLIC_API_BASE_URL||window.location.origin,a="".concat(s,"/api/messages/sse?projectId=").concat(e,"&userId=").concat(r);try{let s=new EventSource(a);s.onopen=()=>{console.log("SSE connection opened for project: ".concat(e))},s.onmessage=r=>{try{let s=JSON.parse(r.data);if(!c(s)){console.log("System message received:",s);return}let t=function(e){for(let[r,s]of d.entries())try{let t=JSON.parse(s);if(t.sender_id===e.sender_id&&t.message===e.message&&1e4>Math.abs(new Date(t.created_at).getTime()-new Date(e.created_at).getTime()))return r}catch(e){console.error("Error parsing temp message data:",e)}return null}(s),a=!!t;a&&d.delete(t),(n.get(e)||[]).forEach(e=>e(s,a))}catch(e){console.error("Error parsing message:",e)}},s.onerror=a=>{console.error("SSE connection error:",a),(0,t.oR)({title:"Connection Error",description:"Failed to connect to messaging service. Retrying...",variant:"destructive"}),s.close(),o.delete(e),setTimeout(()=>{u(e,r)},5e3)},o.set(e,s)}catch(e){console.error("Failed to create SSE connection:",e)}},m=(e,r)=>{var s;n.has(e)||n.set(e,[]),null===(s=n.get(e))||void 0===s||s.push(r)},p=(e,r)=>{let s=n.get(e)||[],t=s.indexOf(r);-1!==t&&(s.splice(t,1),n.set(e,s))},g=e=>{let r=o.get(e);r&&(r.close(),o.delete(e),n.delete(e),console.log("Closed SSE connection for project: ".concat(e)))},h=async(e,r,s,t)=>{try{let l="temp-".concat(Date.now()),n={id:l,project_id:e,sender_id:s,receiver_id:t,message:r,created_at:new Date().toISOString()};d.set(l,JSON.stringify(n));let{data:o,error:c}=await (0,a.A)("POST",i.s.PROJECT.messages(e),{message:r,receiver_id:t});if(c)throw Error(c);return{success:!0,data:o,tempId:l}}catch(e){return console.error("Error sending message:",e),{success:!1,error:e,tempId:null}}}},16891:(e,r,s)=>{"use strict";s.d(r,{F:()=>n});var t=s(95155),a=s(12115),i=s(47655),l=s(53999);let n=a.forwardRef((e,r)=>{let{className:s,children:a,...n}=e;return(0,t.jsxs)(i.bL,{ref:r,className:(0,l.cn)("relative overflow-hidden",s),...n,children:[(0,t.jsx)(i.LM,{className:"h-full w-full rounded-[inherit]",children:a}),(0,t.jsx)(o,{}),(0,t.jsx)(i.OK,{})]})});n.displayName=i.bL.displayName;let o=a.forwardRef((e,r)=>{let{className:s,orientation:a="vertical",...n}=e;return(0,t.jsx)(i.VM,{ref:r,orientation:a,className:(0,l.cn)("flex touch-none select-none transition-colors","vertical"===a&&"h-full w-2.5 border-l border-l-transparent p-[1px]","horizontal"===a&&"h-2.5 border-t border-t-transparent p-[1px]",s),...n,children:(0,t.jsx)(i.lr,{className:"relative flex-1 rounded-full bg-border"})})});o.displayName=i.VM.displayName},65822:(e,r,s)=>{Promise.resolve().then(s.bind(s,73002))},69663:(e,r,s)=>{"use strict";s.d(r,{BK:()=>o,eu:()=>n,q5:()=>d});var t=s(95155),a=s(12115),i=s(54011),l=s(53999);let n=a.forwardRef((e,r)=>{let{className:s,...a}=e;return(0,t.jsx)(i.bL,{ref:r,className:(0,l.cn)("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",s),...a})});n.displayName=i.bL.displayName;let o=a.forwardRef((e,r)=>{let{className:s,...a}=e;return(0,t.jsx)(i._V,{ref:r,className:(0,l.cn)("aspect-square h-full w-full",s),...a})});o.displayName=i._V.displayName;let d=a.forwardRef((e,r)=>{let{className:s,...a}=e;return(0,t.jsx)(i.H4,{ref:r,className:(0,l.cn)("flex h-full w-full items-center justify-center rounded-full bg-muted",s),...a})});d.displayName=i.H4.displayName},73002:(e,r,s)=>{"use strict";s.r(r),s.d(r,{default:()=>_});var t=s(95155),a=s(12115),i=s(35695),l=s(66766),n=s(63008),o=s(47924),d=s(42355),c=s(81497),u=s(12486),m=s(69663),p=s(88145),g=s(97168),h=s(89852),f=s(16891),x=s(66997),v=s(53999),j=s(81347),w=s(33223),b=s(1619),N=s(53580);function _(){var e,r,s,_,y,S;(0,i.useRouter)();let L=(0,i.useSearchParams)(),{user:k}=(0,j.n)(),{projects:E,fetchProjects:A,fetchProjectMessages:T}=(0,w.b)(),[P,O]=(0,a.useState)(null),[F,R]=(0,a.useState)([]),[U,C]=(0,a.useState)([]),[D,I]=(0,a.useState)(""),[z,q]=(0,a.useState)(""),[M,Y]=(0,a.useState)(!1),[H,K]=(0,a.useState)(!0),[B,V]=(0,a.useState)(!0),J=(0,a.useRef)(null);(0,a.useEffect)(()=>{let e=()=>{Y(window.innerWidth<768),window.innerWidth>=768&&K(!0)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),(0,a.useEffect)(()=>{let e=async()=>{V(!0),await A(),V(!1)};k&&e()},[k,A]),(0,a.useEffect)(()=>{if(E.length>0){let e=E.map(e=>({id:e.id,title:e.title,is_group:!0,project_title:e.title,participants:[...e.customer?[{id:e.customer.id,first_name:e.customer.user_name.split(" ")[0]||"",last_name:e.customer.user_name.split(" ")[1]||"",profile_image:e.customer.profile_image,online:!1}]:[],...(e.teamMembers||[]).map(e=>{var r,s;return{id:e.id,first_name:(null===(r=e.user_name)||void 0===r?void 0:r.split(" ")[0])||"",last_name:(null===(s=e.user_name)||void 0===s?void 0:s.split(" ")[1])||"",profile_image:e.profile_image,online:!1}})],unread_count:0,last_message:null}));R(e);let r=L.get("id");r&&E.some(e=>e.id===r)?O(r):e.length>0&&!P&&O(e[0].id)}},[E,L,P]),(0,a.useEffect)(()=>P&&(null==k?void 0:k.id)?((async()=>{V(!0);let{data:e,error:r}=await T(P);r?(0,N.oR)({title:"Error loading messages",description:r,variant:"destructive"}):e&&C(e),V(!1)})(),(0,b.Yf)(P,k.id),(0,b.Nx)(P,function(e){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];console.log("New message received:",e,r?"(replacement)":""),r?C(r=>r.map(r=>r.isTemp&&r.sender_id===e.sender_id&&r.message===e.message?{...e,isTemp:!1}:r)):(C(r=>r.some(r=>r.id===e.id)?r:[...r,e]),R(r=>r.map(r=>r.id===P?{...r,last_message:{content:e.message,created_at:e.created_at,sender_id:e.sender_id}}:r)))}),()=>{(0,b.Gu)(P)}):void 0,[P,null==k?void 0:k.id,T]),(0,a.useEffect)(()=>{var e;null===(e=J.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[U]);let G=F.filter(e=>{let r=e.participants.map(e=>"".concat(e.first_name," ").concat(e.last_name)).join(" ").toLowerCase(),s=e.title.toLowerCase(),t=z.toLowerCase();return r.includes(t)||s.includes(t)}),W=e=>e.title?e.title:e.participants.map(e=>"".concat(e.first_name," ").concat(e.last_name)).join(", "),$=e=>{let r=new Date(e);return(0,n.GP)(r,"h:mm a")},X=e=>e?e.split(" ").map(e=>e[0]).join("").toUpperCase():"U",Q=async e=>{var r,s;if(e.preventDefault(),!D.trim()||!P||!(null==k?void 0:k.id))return;let t="temp-".concat(Date.now()),a=F.find(e=>e.id===P),i="";if("customer"===k.role){let e=null==a?void 0:a.participants.find(e=>e.id!==k.id&&"customer"!==e.role);i=(null==e?void 0:e.id)||P}else{let e=null==a?void 0:a.participants.find(e=>"customer"===e.role||e.id!==k.id);i=(null==e?void 0:e.id)||(null==a?void 0:null===(s=a.participants[0])||void 0===s?void 0:s.id)||""}i||console.log("Using project ID as receiver:",i=P);let l={id:t,project_id:P,sender_id:k.id,receiver_id:i,message:D,created_at:new Date().toISOString(),isTemp:!0,sender:{id:k.id,user_name:k.user_name||"You",profile_image:k.profile_image,role:k.role}};C(e=>[...e,l]),I(""),null===(r=J.current)||void 0===r||r.scrollIntoView({behavior:"smooth"});try{console.log("Sending message to:",i);let e=await (0,b._z)(P,D,k.id,i);e.success?e.data&&C(r=>r.map(r=>r.id===t?{...e.data,isTemp:!1}:r)):(C(e=>e.map(e=>e.id===t?{...e,sendFailed:!0}:e)),(0,N.oR)({title:"Failed to send message",description:"Please try again",variant:"destructive"}))}catch(e){console.error("Error sending message:",e),C(e=>e.map(e=>e.id===t?{...e,sendFailed:!0}:e)),(0,N.oR)({title:"Failed to send message",description:"Please try again",variant:"destructive"})}},Z=F.find(e=>e.id===P);return k?B&&!P?(0,t.jsx)("div",{className:"flex h-[calc(100vh-4rem)] items-center justify-center rounded-lg border bg-background",children:(0,t.jsxs)("div",{className:"flex flex-col items-center gap-2",children:[(0,t.jsx)("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"Loading messages..."})]})}):(0,t.jsxs)("div",{className:"flex h-[calc(100vh-4rem)] overflow-hidden rounded-lg border bg-background",children:[H&&(0,t.jsxs)("div",{className:"w-full md:w-80 border-r flex flex-col h-full",children:[(0,t.jsx)("div",{className:"p-4 border-b shrink-0",children:(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(o.A,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground"}),(0,t.jsx)(h.p,{placeholder:"Search conversations...",className:"pl-9",value:z,onChange:e=>q(e.target.value)})]})}),(0,t.jsx)(f.F,{className:"flex-1",children:G.length>0?G.map(e=>{var r,s,a,i,n;return(0,t.jsxs)("div",{className:(0,v.cn)("flex items-start gap-3 p-3 cursor-pointer hover:bg-muted/50 transition-colors",P===e.id&&"bg-muted"),onClick:()=>{O(e.id),M&&K(!1)},children:[e.is_group?(0,t.jsx)("div",{className:"relative flex -space-x-2",children:e.participants.slice(0,3).map((e,r)=>(0,t.jsx)("div",{className:"relative h-10 w-10 rounded-full border-2 border-background overflow-hidden",style:{zIndex:3-r},children:(0,t.jsx)(l.default,{src:e.profile_image||"/placeholder.svg?height=40&width=40&query=user ".concat(e.first_name||"/placeholder.svg"),alt:"".concat(e.first_name," ").concat(e.last_name),fill:!0,className:"object-cover"})},e.id))}):(0,t.jsxs)("div",{className:"relative h-10 w-10 rounded-full overflow-hidden",children:[(0,t.jsx)(l.default,{src:(null===(r=e.participants[0])||void 0===r?void 0:r.profile_image)||"/placeholder.svg?height=40&width=40&query=user ".concat((null===(s=e.participants[0])||void 0===s?void 0:s.first_name)||"/placeholder.svg"),alt:"".concat(null===(a=e.participants[0])||void 0===a?void 0:a.first_name," ").concat(null===(i=e.participants[0])||void 0===i?void 0:i.last_name),fill:!0,className:"object-cover"}),(null===(n=e.participants[0])||void 0===n?void 0:n.online)&&(0,t.jsx)("span",{className:"absolute bottom-0 right-0 h-3 w-3 rounded-full bg-green-500 border-2 border-background"})]}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("h3",{className:"font-medium truncate",children:W(e)}),e.last_message&&(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:$(e.last_message.created_at)})]}),e.project_title&&(0,t.jsx)("div",{className:"mt-1",children:(0,t.jsx)(p.E,{variant:"outline",className:"text-xs font-normal",children:e.project_title})}),e.last_message&&(0,t.jsxs)("p",{className:"text-sm text-muted-foreground truncate mt-1",children:[e.last_message.sender_id===k.id?(0,t.jsx)("span",{className:"text-muted-foreground",children:"You: "}):"",e.last_message.content]}),e.unread_count>0&&(0,t.jsx)("div",{className:"mt-1",children:(0,t.jsx)(p.E,{className:"text-xs",children:e.unread_count})})]})]},e.id)}):(0,t.jsx)("div",{className:"p-4 text-center text-muted-foreground",children:"No conversations found"})})]}),(0,t.jsx)("div",{className:"flex-1 flex flex-col h-full",children:Z?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"flex items-center justify-between p-4 border-b shrink-0",children:(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[M&&(0,t.jsx)(g.$,{variant:"ghost",size:"icon",onClick:()=>K(!0),className:"md:hidden",children:(0,t.jsx)(d.A,{className:"h-5 w-5"})}),Z.is_group?(0,t.jsx)("div",{className:"relative flex -space-x-2",children:Z.participants.slice(0,3).map((e,r)=>(0,t.jsx)("div",{className:"relative h-10 w-10 rounded-full border-2 border-background overflow-hidden",style:{zIndex:3-r},children:(0,t.jsx)(l.default,{src:e.profile_image||"/placeholder.svg?height=40&width=40&query=user ".concat(e.first_name||"/placeholder.svg"),alt:"".concat(e.first_name," ").concat(e.last_name),fill:!0,className:"object-cover"})},e.id))}):(0,t.jsxs)("div",{className:"relative h-10 w-10 rounded-full overflow-hidden",children:[(0,t.jsx)(l.default,{src:(null===(e=Z.participants[0])||void 0===e?void 0:e.profile_image)||"/placeholder.svg?height=40&width=40&query=user ".concat((null===(r=Z.participants[0])||void 0===r?void 0:r.first_name)||"/placeholder.svg"),alt:"".concat(null===(s=Z.participants[0])||void 0===s?void 0:s.first_name," ").concat(null===(_=Z.participants[0])||void 0===_?void 0:_.last_name),fill:!0,className:"object-cover"}),(null===(y=Z.participants[0])||void 0===y?void 0:y.online)&&(0,t.jsx)("span",{className:"absolute bottom-0 right-0 h-3 w-3 rounded-full bg-green-500 border-2 border-background"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h2",{className:"font-medium",children:W(Z)}),Z.is_group?(0,t.jsxs)("p",{className:"text-xs text-muted-foreground",children:[Z.participants.length," members"]}):(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:(null===(S=Z.participants[0])||void 0===S?void 0:S.online)?"Online":"Offline"})]})]})}),(0,t.jsxs)(f.F,{className:"flex-1 p-4 bg-slate-50/50 dark:bg-slate-900/50",id:"messages-container",children:[U.length>0?(e=>{let r={};return e.forEach(e=>{let s=new Date(e.created_at).toLocaleDateString(void 0,{year:"numeric",month:"long",day:"numeric"});r[s]||(r[s]=[]),r[s].push(e)}),Object.entries(r).map(e=>{let[r,s]=e;return{date:r,messages:s}})})(U).map((e,r)=>(0,t.jsxs)("div",{className:"space-y-3 mb-6",children:[(0,t.jsx)("div",{className:"flex items-center justify-center my-4",children:(0,t.jsx)("div",{className:"bg-slate-200/70 dark:bg-slate-800/70 px-3 py-1 rounded-full text-xs font-medium text-slate-700 dark:text-slate-300",children:e.date})}),e.messages.map((s,a)=>{var i,l,n,o,d,c,u,g,h,f,v;let j=(null===(i=s.sender)||void 0===i?void 0:i.id)===(null==k?void 0:k.id),w=s.isTemp,b=0===a||(null===(n=e.messages[a-1])||void 0===n?void 0:null===(l=n.sender)||void 0===l?void 0:l.id)!==(null===(o=s.sender)||void 0===o?void 0:o.id);return(0,t.jsxs)(x.P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.2,delay:.05*a},className:"flex gap-2 ".concat(j?"justify-end":"justify-start"," ").concat(b||j?"":"pl-10"," ").concat(!b&&j?"pr-10":""," mb-3"),children:[!j&&b&&(0,t.jsxs)(m.eu,{className:"h-8 w-8 mt-1 flex-shrink-0",children:[(0,t.jsx)(m.BK,{src:(null===(d=s.sender)||void 0===d?void 0:d.profile_image)||void 0,alt:(null===(c=s.sender)||void 0===c?void 0:c.user_name)||"User"}),(0,t.jsx)(m.q5,{className:"text-xs ".concat((null===(u=s.sender)||void 0===u?void 0:u.role)==="admin"||(null===(g=s.sender)||void 0===g?void 0:g.role)==="team_member"?"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300":"bg-emerald-100 text-emerald-700 dark:bg-emerald-900 dark:text-emerald-300"),children:X((null===(h=s.sender)||void 0===h?void 0:h.user_name)||"User")})]}),j&&b&&(0,t.jsxs)(m.eu,{className:"h-8 w-8 mt-1 flex-shrink-0 order-2 ml-2",children:[(0,t.jsx)(m.BK,{src:(null==k?void 0:k.profile_image)||void 0,alt:(null==k?void 0:k.user_name)||"You"}),(0,t.jsx)(m.q5,{className:"bg-primary text-white text-xs",children:X((null==k?void 0:k.user_name)||"You")})]}),(0,t.jsxs)("div",{className:"flex flex-col ".concat(j?"items-end":"items-start"," max-w-[80%]"),children:[b&&!j&&(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,t.jsx)("p",{className:"text-xs font-medium",children:(null===(f=s.sender)||void 0===f?void 0:f.user_name)||"User"}),(null===(v=s.sender)||void 0===v?void 0:v.role)&&(0,t.jsx)(p.E,{variant:"outline",className:"text-[10px] px-1.5 py-0 border-slate-200 bg-slate-100 dark:border-slate-700 dark:bg-slate-800",children:"admin"===s.sender.role?"Admin":"team_member"===s.sender.role?"Team":"Client"})]}),(0,t.jsxs)("div",{className:"rounded-lg px-3 py-2 ".concat(j?"bg-primary text-white dark:bg-primary dark:text-white ".concat(w?"opacity-70":""):"bg-white dark:bg-slate-800 shadow-sm border border-slate-100 dark:border-slate-700"),children:[(0,t.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:s.message}),(0,t.jsxs)("div",{className:"flex items-center justify-end gap-1 mt-1",children:[(0,t.jsx)("p",{className:"text-[10px] ".concat(j?"text-white/70":"text-muted-foreground"),children:new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),w&&(0,t.jsx)("span",{className:"text-[10px] italic text-white/70",children:j?"sending...":""}),s.sendFailed&&(0,t.jsx)("span",{className:"text-[10px] text-red-300 italic",children:"failed to send"})]})]})]})]},s.id||"".concat(r,"-").concat(a))})]},e.date)):(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center h-[300px] text-center",children:[(0,t.jsx)("div",{className:"rounded-full bg-primary/5 p-3 mb-3",children:(0,t.jsx)(c.A,{className:"h-6 w-6 text-primary/70"})}),(0,t.jsx)("h3",{className:"text-base font-medium mb-1",children:"No messages yet"}),(0,t.jsx)("p",{className:"text-muted-foreground text-sm max-w-md mb-4",children:"Start the conversation with your team or client to discuss project details."})]}),(0,t.jsx)("div",{ref:J})]}),(0,t.jsx)("div",{className:"border-t bg-white dark:bg-slate-900 p-3",children:(0,t.jsxs)("form",{onSubmit:Q,className:"flex items-center gap-2",children:[(0,t.jsxs)(m.eu,{className:"h-8 w-8 flex-shrink-0",children:[(0,t.jsx)(m.BK,{src:(null==k?void 0:k.profile_image)||void 0,alt:(null==k?void 0:k.user_name)||"You"}),(0,t.jsx)(m.q5,{className:"bg-primary/10 text-primary text-xs",children:X((null==k?void 0:k.user_name)||"You")})]}),(0,t.jsxs)("div",{className:"flex-1 relative",children:[(0,t.jsx)("input",{type:"text",className:"w-full px-3 py-2 pr-10 rounded-full border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:outline-none focus:ring-1 focus:ring-primary/30 text-sm",placeholder:"Type your message here...",value:D,onChange:e=>I(e.target.value),onKeyDown:e=>{"Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),D.trim()&&Q(e))}}),(0,t.jsx)(g.$,{type:"submit",size:"icon",disabled:!D.trim(),className:"h-7 w-7 absolute right-1.5 top-1/2 -translate-y-1/2 rounded-full bg-primary hover:bg-primary/90 text-white",children:(0,t.jsx)(u.A,{className:"h-4 w-4 rotate-45"})})]})]})})]}):(0,t.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("h2",{className:"text-xl font-medium",children:"Select a conversation"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"Choose a project from the list to start messaging"})]})})})]}):(0,t.jsx)("div",{className:"flex h-[calc(100vh-4rem)] items-center justify-center rounded-lg border bg-background",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("h2",{className:"text-xl font-medium",children:"Please sign in"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"You need to be signed in to view messages"})]})})}},81347:(e,r,s)=>{"use strict";s.d(r,{n:()=>o});var t=s(65453),a=s(6807),i=s(34477);let l=(0,i.createServerReference)("0078e71f6cc7e95d02d9cdc97ddb6eaa3edb2c55f8",i.callServer,void 0,i.findSourceMapURL,"getServerSideProfile");var n=s(53919);let o=(0,t.v)()((e,r)=>({user:null,isAuthenticated:!1,isLoading:!1,error:null,initialize:async()=>{try{e({isLoading:!0});let r=await l();if(r.success&&r.user)return e({user:r.user,isAuthenticated:!0,isLoading:!1,error:null}),!0;return e({user:null,isAuthenticated:!1,isLoading:!1,error:r.error||null}),!1}catch(r){return console.error("Failed to initialize auth:",r),e({user:null,isAuthenticated:!1,isLoading:!1}),!1}},signIn:async(r,s)=>{e({isLoading:!0,error:null});try{let{data:t,error:i}=await (0,a.A)("POST",n.s.AUTH.signIn,{email:r,password:s});if(i)return e({isLoading:!1,error:i}),{data:null,error:i};let o=await l();return o.success&&o.user?e({user:o.user,isAuthenticated:!0,isLoading:!1,error:null}):e({user:null==t?void 0:t.user,isAuthenticated:!0,isLoading:!1,error:null}),{data:t,error:null}}catch(s){console.error("Sign in error:",s);let r=s.message||"Failed to sign in. Please check your network connection and try again.";return e({isLoading:!1,error:r}),{data:null,error:r}}},signUp:async(r,s)=>{e({isLoading:!0,error:null});try{let{data:t,error:i}=await (0,a.A)("POST",n.s.AUTH.signUp,{email:r,user_name:s||r.split("@")[0]});if(i)return e({isLoading:!1,error:i}),{data:null,error:i};return e({isLoading:!1,error:null}),{data:t,error:null}}catch(s){console.error("Sign up error:",s);let r=s.message||"Failed to sign up";return e({isLoading:!1,error:r}),{data:null,error:r}}},verifyToken:async r=>{e({isLoading:!0,error:null});try{let{data:s,error:t}=await (0,a.A)("POST",n.s.AUTH.verifyToken,{token:r});if(e({isLoading:!1}),t)return{data:null,error:t};return{data:s,error:null}}catch(s){console.error("Token verification error:",s);let r=s.message||"Failed to verify token";return e({isLoading:!1}),{data:null,error:r}}},forgotPassword:async r=>{e({isLoading:!0,error:null});try{let{error:s}=await (0,a.A)("POST",n.s.AUTH.forgotPassword,{email:r});return e({isLoading:!1,error:s||null}),{error:s||null}}catch(s){console.error("Forgot password error:",s);let r=s.message||"Failed to process forgot password request";return e({isLoading:!1,error:r}),{error:r}}},resetPassword:async(r,s)=>{e({isLoading:!0,error:null});try{let{error:t}=await (0,a.A)("POST",n.s.AUTH.resetPassword,{token:r,password:s});return e({isLoading:!1,error:t||null}),{error:t||null}}catch(s){console.error("Reset password error:",s);let r=s.message||"Failed to reset password";return e({isLoading:!1,error:r}),{error:r}}},loadProfile:async()=>{try{e({isLoading:!0});let r=await l();r.success&&r.user?e({user:r.user,isAuthenticated:!0,isLoading:!1,error:null}):e({isAuthenticated:!1,user:null,isLoading:!1,error:r.error||null})}catch(r){console.error("Error loading profile:",r),e({isAuthenticated:!1,user:null,isLoading:!1,error:"Failed to load profile"})}},signOut:async()=>{e({isLoading:!0}),window.location.href="/login";try{let{error:r}=await (0,a.A)("POST",n.s.AUTH.signOut);e({user:null,isAuthenticated:!1}),window.location.href="/login"}catch(r){console.error("Sign out error:",r),e({user:null,isAuthenticated:!1}),window.location.href="/login"}finally{e({isLoading:!1})}},clearError:()=>e({error:null})}))}},e=>{var r=r=>e(e.s=r);e.O(0,[2848,5687,8138,7938,3678,5518,753,4084,8441,1684,7358],()=>r(65822)),_N_E=e.O()}]);